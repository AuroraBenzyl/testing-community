name: Sync Contributors and Roadmap
on:
  workflow_dispatch:
jobs:
    sync-contributors-data:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository  
              uses: actions/checkout@v4
        
            - name: Get Token
              uses: actions/create-github-app-token@v1
              id: get_workflow_token
              with:
                app-id: ${{ vars.APPLICATION_ID }}
                private-key: ${{ secrets.APP_PRIVATE_KEY }}

            # Fetch Contributors data using github script with pagination
            - name: Fetch Contributors data
              uses: actions/github-script@v7
              env:
                GH_TOKEN: ${{ steps.get_workflow_token.outputs.token }}
              with:
                github-token: ${{ env.GH_TOKEN }}
                script: |
                  const fs = require('fs');
                  
                  let data = await github.paginate(github.rest.repos.listContributors, {
                    owner: "json-schema-org",
                    repo: "website",
                    per_page: 100,
                    headers: {
                      "X-GitHub-Api-Version": "2022-11-28",
                    },
                  });
                  
                  console.log(JSON.stringify(data, null, 2));
                  
                  // Filter the data to get only the required fields [login, id, avatar_url, html_url, contributions]
                  data = data.map(({ login, id, avatar_url, html_url, contributions }) => ({ login, id, avatar_url, html_url, contributions }));
                  
                  // Store the data in a file
                  fs.writeFileSync('community.json', JSON.stringify(data, null, 2));
                 
            # Commit the updated contributors data
            - name: Commit changes
              env:
                GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
              run: |
                git config --global user.email "github-actions[bot]@users.noreply.github.com"
                git config --global user.name "github-actions[bot]"
                git add community.json
                git commit -m "Update community.json"
                git push
